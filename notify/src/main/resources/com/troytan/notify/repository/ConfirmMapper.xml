<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.troytan.notify.repository.ConfirmMapper">
  <resultMap id="BaseResultMap" type="com.troytan.notify.domain.Confirm">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="CONFIRM_ID" jdbcType="INTEGER" property="confirmId" />
    <result column="STATUS" jdbcType="SMALLINT" property="status" />
    <result column="NOTIFY_ID" jdbcType="INTEGER" property="notifyId" />
    <result column="CREATE_BY" jdbcType="INTEGER" property="createBy" />
    <result column="CREATE_ON" jdbcType="TIMESTAMP" property="createOn" />
    <result column="UPDATE_BY" jdbcType="INTEGER" property="updateBy" />
    <result column="UPDATE_ON" jdbcType="TIMESTAMP" property="updateOn" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from tt_confirm
    where CONFIRM_ID = #{confirmId,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.troytan.notify.domain.Confirm">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <selectKey keyProperty="confirmId" order="AFTER" resultType="java.lang.Integer">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into tt_confirm (STATUS, NOTIFY_ID, CREATE_BY, 
      CREATE_ON, UPDATE_BY, UPDATE_ON
      )
    values (#{status,jdbcType=SMALLINT}, #{notifyId,jdbcType=INTEGER}, #{createBy,jdbcType=INTEGER}, 
      now(), #{updateBy,jdbcType=INTEGER}, #{updateOn,jdbcType=TIMESTAMP}
      )
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.troytan.notify.domain.Confirm">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update tt_confirm
    set STATUS = #{status,jdbcType=SMALLINT},
      NOTIFY_ID = #{notifyId,jdbcType=INTEGER},
      UPDATE_BY = #{updateBy,jdbcType=INTEGER},
      UPDATE_ON = now()
    where CONFIRM_ID = #{confirmId,jdbcType=INTEGER}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select CONFIRM_ID, STATUS, NOTIFY_ID, CREATE_BY, CREATE_ON, UPDATE_BY, UPDATE_ON
    from tt_confirm
    where CONFIRM_ID = #{confirmId,jdbcType=INTEGER}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select CONFIRM_ID, STATUS, NOTIFY_ID, CREATE_BY, CREATE_ON, UPDATE_BY, UPDATE_ON
    from tt_confirm
  </select>
  
  <update id="updateStatusByNotifyId">
    update tt_confirm set status=#{status,jdbcType=SMALLINT},
       UPDATE_ON = now()
    where NOTIFY_ID=#{notifyId, jdbcType=INTEGER}
        and CREATE_BY=#{userId, jdbcType=INTEGER}
  </update>
  <resultMap type="com.troytan.notify.dto.ConfirmDto" id="ConfirmDtoResultMap">
    <result column="AVATAR_URL" jdbcType="VARCHAR"  property="avatarUrl" />
    <result column="NICKNAME"  jdbcType="VARCHAR"   property="nickName"/>
    <result column="UPDATE_ON" jdbcType="TIMESTAMP" property="updateOn" />
  </resultMap>
  <!-- 获取确认人员列表 -->
  <select id="listConfirmByNotifyId" parameterType="java.lang.Integer" resultMap="ConfirmDtoResultMap">
    select user.AVATAR_URL,ifnull(gu.NICKNAME,user.NICKNAME) as NICKNAME,confirm.UPDATE_ON from tt_confirm confirm
    left join tm_user user on user.USER_ID=confirm.CREATE_BY
	left join tt_group_user gu on gu.GROUP_ID=(select GROUP_ID from tt_notify 
	     where NOTIFY_ID=#{notifyId, jdbcType=INTEGER}) and gu.OPEN_ID = user.OPEN_ID
    where NOTIFY_ID=#{notifyId, jdbcType=INTEGER} 
         and confirm.STATUS=2
  </select>
  <select id="selectByUserAndNotify"  resultMap="BaseResultMap">
    select CONFIRM_ID, STATUS, NOTIFY_ID, CREATE_BY, CREATE_ON, UPDATE_BY, UPDATE_ON
    from tt_confirm
    where NOTIFY_ID = #{notifyId,jdbcType=INTEGER}
        and CREATE_BY = #{userId, jdbcType=INTEGER}
   </select>
</mapper>